<!doctype html>
<html>
	<head>
		<!-- meta type for bulgarian language -->
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		
		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
		<!-- Optional theme -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
		<!-- CSS for datetimepicker function -->
		<link href="css/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">
		<!-- CSS file for the clock -->
		<link href="css/clockStyle.css" rel="stylesheet" />
		
		<title> Briz Report </title>
	</head>
	
	<body style="background-color: #EEE;">
		
		<!-- Navbar -->
		<nav class="navbar navbar-inverse navbar-fixed-top" id="my-navbar">
			<!-- Navbar Logo -->
			<ul class="nav navbar-nav">
				<a href="http://mbal-ruse.cf/" title="МБАЛ-Русе">
					<img src="images/logo3.svg">
				</a>
			</ul>
			
			<div class="container">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					
					
				</div><!-- Navbar Header -->
				<div class="collapse navbar-collapse" id="navbar-collapse">
					<ul class="nav navbar-nav">
						<li><a href="report.html" rel="external">Добави пациент</a>
						<li><a href="editPatient.html">Справка за пациент</a>
						<!-- <li><a href="sendPatient.html">Изпрати писмо</a> Depricated for now (it works) -->
						<!-- <li><a href="exportPatient.html">Експорт на пациент</a> -->
					</ul>
					
					<!-- Navi clock -->
					<div id="clock" class="light dark nav navbar-right">
						<div class="display">
							<!-- <div class="weekdays"></div> -->
							<!-- <div class="ampm"></div> -->
							<!-- <div class="alarm"></div> -->
							<div class="digits"></div>
						</div>
					</div> <!-- End navi clock -->
				</div>
			</div><!-- End Container -->
		</nav><!-- End navbar -->
	
	
		<!-- jumbotron -->
		<div class="jumbotron">
			<div class="container text-center">
				<!-- Main section -->
				<section id="main-content">
					<div id="guts">
						<h1 style="margin-top:0.6em; margin-bottom:0.6em;">Добавяне на пациент</h1>
						<div class="col-lg-8" style="width:100%; height:100%">
							<form action="database/insert.php" name="Save Patient" method="post" class="form-horizontal" id="regForm" target="myIframe">
							
								<div class="form-group">
									<label for="firstName" class="col-lg-2 control-label">Име</label>
									<div class="col-md-8">
										<input type="text" class="form-control" name="firstName" id="firstName" maxlength="20" pattern="[A-Za-zА-Яа-я]{2,20}" placeholder="Въведете име" required>
									</div>
								</div> <!-- End form group -->
								
								<div class="form-group">
									<label for="user-secondName" class="col-lg-2 control-label">Презиме</label>
									<div class="col-md-8">
										<input type="text" class="form-control" name="secondName" id="user-secondName" placeholder="Въведете презиме" maxlength="20" pattern="[A-Za-zА-Яа-я]{2,20}" required>
									</div>
								</div> <!-- End form group -->
								
								<div class="form-group">
									<label for="user-lastName" class="col-lg-2 control-label">Фамилия</label>
									<div class="col-md-8">
										<input type="text" class="form-control" name="lastName" id="user-lastName" placeholder="Въведете фамилия" maxlength="20" pattern="[A-Za-zА-Яа-я]{2,20}" required>
									</div>
								</div> <!-- End form group -->
								
								<div class="form-group">
									<label for="user-personId" class="col-lg-2 control-label">
										<!-- ЕГН -->
										<select class="form-control btn btn-default dropdown-toggle" name="idLabel" id="user-idLabel" data-toggle="dropdown" value="ЕГН" required>
											<option value="ЕГН">ЕГН</option>
											<option value="ЛНЧ">ЛНЧ</option>
											<option value="СНН">СНН</option>
										</select>
									</label>
									<div class="col-md-8" id="patientIdErrField">
										<input type="text" class="form-control" name="patientId" id="user-patientId" placeholder="Въведете ЕГН/ЛНЧ" pattern="\d{1,10}" maxlength="10" required>
										<span class="glyphicon glyphicon-remove form-control-feedback" id="onErrorSpan" style="display:none"></span>
									</div>
								</div> <!-- End form group -->
								
								<div class="form-group">
									<label for="user-department" class="col-lg-2 control-label">Отделение</label>
									<div class="col-md-8">
									
										<select class="form-control btn btn-default dropdown-toggle" name="department" data-toggle="dropdown" id="user-department" value="" required>
											<option value="">Изберете отделение</option>
											<option value="Отделение по очни болести">Отделение по очни болести</option>
											<option value="Отделение по обща и съдова неврология">Отделение по обща и съдова неврология</option>
											<option value="Отделение по УНГ болести">Отделение по УНГ болести</option>
											<option value="II отделение по ВБ">II отделение по ВБ</option>
											<option value="III отделение по ВБ">III отделение по ВБ</option>
											<option value="Отделение съдова хирургия">Отделение съдова хирургия</option>
											<option value="Отделение ПВЕХ">Отделение ПВЕХ</option>
											<option value="ОФРМ">ОФРМ</option>
											<option value="Отделение ортопения и травматология">Отделение ортопения и травматология</option>
											<option value="Отделение урология">Отделение урология</option>
											<option value="Отделение ОГСДЕХ">Отделение ОГСДЕХ</option>
											<option value="Отделение неврохирургия">Отделение неврохирургия</option>
											<option value="ОАИЛ - ИЛЗХН">ОАИЛ - ИЛЗХН</option>
											<option value="ОИЛ на заболявания с тер. насоченост"> ОИЛ на заболявания с тер. насоченост</option>
											<option value="Отделение по педиатрия">Отделение по педиатрия</option>
											<option value="I отделение по ВБ">I отделение по ВБ</option>
											<option value="Отделение диализно лечение">Отделение диализно лечение</option>
											<option value="Отделение неинвазивна кард. диагностика">Отделение неинвазивна кард. диагностика</option>
											<option value="Отделение по инфекциозни болести">Отделение по инфекциозни болести</option>
											<option value="Отделение Родилно">Отделение Родилно</option>
											<option value="Отделение Гинекология">Отделение Гинекология</option>
											<option value="ОАИЛ - АИЛАГ">ОАИЛ - АИЛАГ</option>
											<option value="Отделение патологична бременност">Отделение патологична бременност</option>
											<option value="Отделение Неонатология">Отделение Неонатология</option>
										</select>
										
									</div>
								</div> <!-- End form group -->
								
								<div class="form-group">
									<label for="user-exception" class="col-lg-2 control-label">Изключение</label>
									<div class="col-md-8">
										<select class="form-control btn btn-default dropdown-toggle" name="exception" id="user-exception" data-toggle="dropdown" value="" required>
											<option value="">Изберете изключение</option>
											<option value="Починал">Починал</option>
											<option value="Отказ от генериране на УИН">Отказ от генериране на УИН</option>
											<option value="Временна невъзможност">Временна невъзможност</option>
											<option value="Трайна невъзможност">Трайна невъзможност</option>
											<option value="Самоволно напуснал">Самоволно напуснал</option>
											<option value="Спешно/живитозастрашаващо състояние">Спешно/живитозастрашаващо състояние</option>
											<option value="Неработещо устройство за УИН">Неработещо устройство за УИН</option>
											<option value="Не се генерира УИН за типа регистрация">Не се генерира УИН за типа регистрация</option>
										</select>
									</div>
								</div> <!-- End form group -->
								
								<div class="form-group">
									<label for="user-date" class="col-lg-2 control-label">Дата на събитието</label>
									<div class="col-lg-10">
										<div class="input-group date form_date col-md-5" data-date="" data-date-format="dd MM yyyy" data-link-field="dtp_input2" data-link-format="yyyy-mm-dd">
											<input class="form-control" name="datePatient" id="user-date" size="16" type="text" required value="" readonly> <!-- it was readonly -->
											<span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
											<span class="input-group-addon"><span class="glyphicon glyphicon-calendar" onclick="openCalendar()"></span></span>
										</div>
										<input type="hidden" id="dtp_input2" value="" /><br/>
									</div>
								</div> <!-- End form group -->
								
								<div class="form-group">
									<label for="user-about" class="col-lg-2 control-label">Причина</label>
									<div class="col-md-8">
										<textarea name="about" class="form-control" cols="20" rows="10" id="user-about" placeholder="Въведете причина" style="resize:none" id="user-about" required></textarea>
									</div>
								</div> <!-- End form group -->
								
								<!-- Success message -->
								<div id="successMessage" style="display:none">
										<div class="alert alert-success fade in">
											<a href="#" class="close" data-dismiss="alert">&times;</a>
											<strong>Успех!</strong> Данните бяха записани и изпратени успешно.
										</div>
								</div> <!-- End Success message -->
								
								<!-- Error message -->
								<div id="errorMessage" style="display:none">
										<div class="alert alert-danger fade in">
											<a href="#" class="close" data-dismiss="alert">&times;</a>
											<strong>Грешка!</strong> ЕГН-то, което сте въвели е сгрешено.
										</div>
								</div> <!-- End Success message -->
								
								<div class="form-group">
									<div class="btn-margin" style="margin-top:1.5em;">
										<button type="submit" value="Submit" class="btn btn-primary btn-lg" id="subButton" onclick="formSubmit()">Добави</button>
										<button type="reset" value="Reset" class="btn btn-secondary btn-lg" style="margin-left:3em;" onclick="formReset()">Изчисти</button>
									</div>
								</div> <!-- End form group -->
				
							</form> 
							
							<!-- iframe dummy -->
							<iframe name="myIframe" width=0 height=0 style="hidden" frameborder=0 marginheight=0 marginwidth=0 scrolling=no>
								<!-- Empty -->
							</iframe>
							
						</div>
					</div>
				</section> <!-- End main section -->
			</div>
		</div> <!-- End jumbotron -->
	
	
		
		<!-- Load jquery library -->
		<script type="text/javascript" src="http://code.jquery.com/jquery-3.1.1.min.js"></script>
		<!-- Latest compiled and minified JavaScript -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
		<!-- DateTime picker library -->
		<script type="text/javascript" src="js/bootstrap-datetimepicker.js" charset="UTF-8"></script>
		<script type="text/javascript" src="js/bootstrap-datetimepicker.bg.js" charset="UTF-8"></script>
		<!-- Special script for date-time -->
		<!-- JavaScript Includes for the clock -->
		<script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.0.0/moment.min.js"></script>
		<script src="js/clock.js"></script>
		<!-- javascript for checking personId -->
		<script src="js/id-check.js"></script>
		<!-- Special script for date-time -->
		<script type="text/javascript">
			function openCalendar() {
				$('.form_date').datetimepicker({
					language: 'bg',
					format: 'dd-mm-yyyy',
					endDate: '+0d',
					weekStart: 1,
					todayBtn:  1,
					autoclose: 1,
					todayHighlight: 1,
					startView: 2,
					minView: 2,
					forceParse: 0
				});
			}
		</script>
		<!-- Script after submit form -->
		<script type="text/javascript">
			function formSubmit() {
			
				var idResult = checkEgn(document.getElementById("user-patientId").value);
				var label = document.getElementById("user-idLabel").value;
				
				if (idResult == true && label.contains('ЕГН')) {
				
					document.getElementById("errorMessage").style.display = "none";
					document.getElementById("patientIdErrField").className = "col-md-8";
					document.getElementById("onErrorSpan").style.display = "none";
					
					// set data-after-submit-value on input:submit to disable button after submit
					$(document).off('submit');
					$(document).on('submit', '#regForm', function() {
					
						// Test Send function
						firstName = document.getElementById("firstName").value;
						secondName = document.getElementById("user-secondName").value;
						lastName = document.getElementById("user-lastName").value;
						patientId = document.getElementById("user-patientId").value;
						department = document.getElementById("user-department").value;
						exception = document.getElementById("user-exception").value;
						about = document.getElementById("user-about").value;
						date = document.getElementById("user-date").value;
					
						sent_value(firstName, secondName, lastName, patientId, department, exception, about, date);
					
						console.log("mail send!!!");
					
						document.getElementById("successMessage").style.display = "block";
						document.getElementById("subButton").disabled = true;
					
					});
				} else {
					if (!label.contains('ЕГН')){
					
						document.getElementById("errorMessage").style.display = "none";
						document.getElementById("patientIdErrField").className = "col-md-8";
						document.getElementById("onErrorSpan").style.display = "none";
						
						// set data-after-submit-value on input:submit to disable button after submit
						$(document).off('submit');
						$(document).on('submit', '#regForm', function() {
					
							// Test Send function
							firstName = document.getElementById("firstName").value;
							secondName = document.getElementById("user-secondName").value;
							lastName = document.getElementById("user-lastName").value;
							patientId = document.getElementById("user-patientId").value;
							department = document.getElementById("user-department").value;
							exception = document.getElementById("user-exception").value;
							about = document.getElementById("user-about").value;
							date = document.getElementById("user-date").value;
					
							sent_value(firstName, secondName, lastName, patientId, department, exception, about, date);
						
							console.log("mail send!!!");
					
							document.getElementById("successMessage").style.display = "block";
							document.getElementById("subButton").disabled = true;
					
						});
					} else {
						document.getElementById("errorMessage").style.display = "block";
						document.getElementById("patientIdErrField").className = "col-md-8 has-error has-feedback";
						document.getElementById("onErrorSpan").style.display = "block";
					}
					
				}
				
				
			}
			function formReset() {							
				document.getElementById("successMessage").style.display = "none";
				document.getElementById("subButton").disabled = false;
			}
			function sent_value(firstName, secondName, lastName, patientId, department, exception, about, date) {
				
				var xmlhttp = new XMLHttpRequest();
				xmlhttp.open("GET","database/send.php?firstName=" + firstName + "&secondName=" + secondName + "&lastName=" + lastName + "&patientId=" + patientId
							+ "&department=" + department + "&exception=" + exception + "&about=" + about + "&date=" + date + "&status=sent", false);
				xmlhttp.send(null);
				
			}
		</script>
		<!-- script for export patients in xls table -->
		<script type="text/javascript">
			var tableToExcel = (function() {
			var uri = 'data:application/vnd.ms-excel;base64,'
					, template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--><meta http-equiv="content-type" content="text/plain; charset=UTF-8"/></head><body><table>{table}</table></body></html>'
					, base64 = function(s) { return window.btoa(unescape(encodeURIComponent(s))) }
					, format = function(s, c) { return s.replace(/{(\w+)}/g, function(m, p) { return c[p]; }) }
			return function(table, name) {
				if (!table.nodeType) table = document.getElementById(table)
				var ctx = {worksheet: name || 'Worksheet', table: table.innerHTML}
				window.location.href = uri + base64(format(template, ctx))
			}
			})()
		</script>
	</body>
</html>